<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="Board">


    <!-- 신고 저장 -->
    <insert  id="declarationInsert" >
        insert into declaration
        (
        d_idx,
        cont,
        us_id,
        ue_id,
        b_idx,
        type_idx
        )
        values
        (
        ( select nvl(max(d_idx),0)+1 from declaration ),
        #{cont},
        #{us_id},
        #{ue_id},
        #{b_idx},
        #{type_idx}
        )
    </insert>

    <!-- 글 수정하기 -->
    <update  id="BoardUpdate">
        <choose>
            <when test="a_cont != null">
                update board
                set   title   = #{title},
                cont    = #{cont},
                a_cont = #{a_cont}
                where b_idx   = #{b_idx}
            </when>
            <otherwise>
                update board
                set   title   = #{title},
                cont    = #{cont},
                r_score = #{r_score}
                where b_idx   = #{b_idx}
            </otherwise>
        </choose>
    </update>


    <!-- 글 저장 -->
    <insert  id="BoardInsert" >
        insert into board
        (
        b_idx,
        title,
        cont,
        r_score,
        b_count,
        menu_id,
        u_id,
        g_idx
        )
        values
        (
        ( select nvl(max(b_idx),0)+1 from board ),
        #{title},
        #{cont},
        #{r_score},
        0,
        #{menu_id},
        #{u_id},
        #{g_idx}
        )
    </insert>

    <select id="GetGameList" resultType="com.project.board.vo.GameListVo">
        SELECT *
          FROM GAMELIST
    </select>

    <!-- 글 목록 카운트 -->
    <select id="Count" resultType="int">
        <choose>
            <when test="BoardCount == 1">
                SELECT COUNT(*)
                FROM BOARD
                where menu_id = ${menu_id}
            </when>
            <when test="BoardOneCount == 1">
                SELECT COUNT(*)
                FROM BOARD
                where menu_id = ${menu_id} and g_idx = ${g_idx}
            </when>
            <when test="MyBoardCount == 1">
                SELECT COUNT(*)
                FROM BOARD
                WHERE U_ID = #{u_id} and menu_id not in ('3','4')
            </when>
            <when test="BoardSCount == 1">
                select count(*)
                from(
                select ROW_NUMBER() OVER (ORDER BY B_IDX ASC) RNUM,
                b_idx,
                title,
                cont,
                r_score,
                TO_CHAR(INDATE + 9/24, 'yyyy-mm-dd hh24:mi') AS indate,
                b_count,
                menu_id,
                g_idx,
                u_id
                from  board
                where menu_id = ${menu_id} and ${searchType} like '%${keyword}%'
                order by b_idx asc)
            </when>
            <when test="MyBoardSCount">
                select count(*)
                from(
                select ROW_NUMBER() OVER (ORDER BY B_IDX ASC) RNUM,
                a.b_idx,
                a.title,
                a.cont,
                a.r_score,
                TO_CHAR(a.INDATE + 9/24, 'yyyy-mm-dd hh24:mi') AS indate,
                a.b_count,
                a.menu_id,
                b.g_name,
                a.g_idx,
                a.u_id
                from board a
                inner join gamelist b
                on a.g_idx = b.g_idx
                where u_id = #{u_id} and ${searchType} like '%${keyword}%' and menu_id not in ('3','4')
                order by b_idx asc)
                WHERE RNUM BETWEEN #{pageNum} and #{contentNum}
            </when>
        </choose>
    </select>

    <!-- 글 목록 불러오기 -->
    <select id="List"
            resultType="com.project.board.vo.BoardVo">
        <choose>
            <when test="menu_id == 3">
                SELECT *
                FROM (
                SELECT ROW_NUMBER() OVER (ORDER BY B_IDX desc) RNUM,
                B_IDX,
                TITLE,
                CONT,
                B_COUNT,
                INDATE
                FROM BOARD
                WHERE menu_id = #{menu_id}
                ORDER BY b_idx desc)
                WHERE RNUM BETWEEN #{pageNum} and #{contentNum}
                ORDER BY b_idx desc
            </when>
            <when test="menu_id == 4">
                <choose>
                    <when test="u_id.equals('admin')">
                        SELECT *
                        FROM (
                        SELECT ROW_NUMBER() OVER (ORDER BY B_IDX desc) RNUM,
                        B_IDX,
                        TITLE,
                        CONT,
                        B_COUNT,
                        INDATE
                        FROM BOARD
                        WHERE menu_id = #{menu_id}
                        ORDER BY b_idx desc)
                        WHERE RNUM BETWEEN #{pageNum} and #{contentNum}
                    </when>
                    <otherwise>
                        SELECT *
                        FROM board
                        WHERE menu_id = #{menu_id}
                        AND u_id = #{u_id}
                        ORDER BY b_idx desc
                    </otherwise>
                </choose>
            </when>
            <when test="g_idx != null">
                SELECT *
                FROM(
                select ROW_NUMBER() OVER (ORDER BY B_IDX desc) RNUM,
                a.b_idx,
                a.title,
                a.cont,
                a.r_score,
                TO_CHAR(a.INDATE + 9/24, 'yyyy-mm-dd hh24:mi') AS indate,
                a.b_count,
                a.menu_id,
                b.g_name,
                a.g_idx,
                a.u_id
                from  board a
                inner join gamelist b
                on a.g_idx = b.g_idx
                where menu_id = ${menu_id} and a.g_idx = ${g_idx}
                order by b_idx desc)
                WHERE RNUM BETWEEN #{pageNum} and #{contentNum}
            </when>
            <when test="myboard == 1">
                SELECT *
                FROM (
                select ROW_NUMBER() OVER (ORDER BY a.B_IDX desc) RNUM,
                a.b_idx,
                a.title,
                a.cont,
                a.r_score,
                TO_CHAR(a.INDATE + 9/24, 'yyyy-mm-dd hh24:mi') AS indate,
                a.b_count,
                a.menu_id,
                b.g_name,
                a.g_idx,
                a.u_id
                from  board a
                inner join gamelist b
                on a.g_idx = b.g_idx
                WHERE a.U_ID = #{u_id} and a.menu_id NOT IN ('3','4')
                ORDER BY a.B_IDX DESC)
                WHERE RNUM BETWEEN #{pageNum} and #{contentNum}
            </when>
            <when test="myboard == 2">
                SELECT *
                FROM (
                select ROW_NUMBER() OVER (ORDER BY a.B_IDX desc) RNUM,
                a.b_idx,
                a.title,
                a.cont,
                a.r_score,
                TO_CHAR(a.INDATE + 9/24, 'yyyy-mm-dd hh24:mi') AS indate,
                a.b_count,
                a.menu_id,
                b.g_name,
                a.g_idx,
                a.u_id
                from  board a
                inner join gamelist b
                on a.g_idx = b.g_idx
                WHERE a.U_ID = #{u_id} and ${searchType} like '%${keyword}%' and a.menu_id = #{menu_id} and a.menu_id NOT IN ('3','4')
                ORDER BY a.B_IDX DESC)
                WHERE RNUM BETWEEN #{pageNum} and #{contentNum}
            </when>
            <when test="homeBoard == 1">
                SELECT *
                FROM (
                SELECT ROW_NUMBER() OVER (ORDER BY B_IDX desc) RNUM,
                TITLE, B_COUNT, MENU_ID, B_IDX
                FROM BOARD
                WHERE MENU_ID = 1
                )
            </when>
            <when test="homeBoard == 2">
                SELECT *
                FROM (
                SELECT ROW_NUMBER() OVER (ORDER BY B_IDX desc) RNUM,
                TITLE, B_COUNT, MENU_ID, B_IDX
                FROM BOARD
                WHERE MENU_ID = 2
                )
            </when>
            <when test="homeBoard == 3">
                SELECT *
                FROM (
                SELECT ROW_NUMBER() OVER (ORDER BY B_IDX desc) RNUM,
                TITLE, B_COUNT, MENU_ID, B_IDX
                FROM BOARD
                WHERE MENU_ID = 3
                )
            </when>
            <otherwise>
                select *
                from(
                select ROW_NUMBER() OVER (ORDER BY a.B_IDX desc) RNUM,
                a.b_idx,
                a.title,
                a.cont,
                a.r_score,
                TO_CHAR(a.INDATE + 9/24, 'yyyy-mm-dd hh24:mi') AS indate,
                a.b_count,
                a.menu_id,
                b.g_name,
                a.g_idx,
                a.u_id
                from  board a
                inner join gamelist b
                on a.g_idx = b.g_idx
                where menu_id = ${menu_id}
                order by b_idx desc)
                WHERE RNUM BETWEEN ${pageNum} and ${contentNum}
            </otherwise>
        </choose>
    </select>

    <!-- 글 불러오기 -->
    <select id="View"
            resultType="com.project.board.vo.BoardVo">
        select *
        from board
        where b_idx = #{b_idx}
    </select>

    <!-- 조회수 증가 -->
    <update  id="ReadCountUpdate">
        update board
        set  b_count = b_count + 1
        where b_idx = #{b_idx}
    </update>

    <!-- 글 삭제하기 -->
    <delete id="Delete">
        delete from board
        where b_idx = #{b_idx}
    </delete>

    <!-- 글 작성 여부 체크 -->
    <select id="BoardCheck"
            resultType="int">
        SELECT COUNT(*)
          FROM board
         WHERE    u_id = #{u_id}
           AND   g_idx = ${g_idx}
           AND menu_id = 1

    </select>

    <!-- 유저 고평가 게임 출력 -->
    <select id="GoodGame"
            resultType="com.project.board.vo.BoardVo">
        <![CDATA[
        SELECT  a.b_idx,
                a.title,
                a.cont,
                a.r_score,
                a.indate,
                a.b_count,
                a.menu_id,
                b.g_name,
                a.g_idx,
                a.u_id
          FROM(
            SELECT *
              FROM(
                SELECT *
                  FROM board
                 WHERE  u_id = #{u_id}
                   AND menu_id = 1
                   AND r_score >= 8
                   AND ROWNUM <= 10
                 ORDER BY r_score DESC
              )
            ORDER BY DBMS_RANDOM.RANDOM
          ) a
        INNER JOIN gamelist b
        ON a.g_idx = b.g_idx
        WHERE ROWNUM = 1
         ]]>
    </select>

</mapper>